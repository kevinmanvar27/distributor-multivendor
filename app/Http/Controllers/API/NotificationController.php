<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\API\ApiController;
use App\Services\NotificationService;
use App\Models\User;
use App\Models\UserGroup;
use App\Models\Notification;
use Illuminate\Http\Request;

/**
 * @OA\Tag(
 *     name="Notifications",
 *     description="API Endpoints for Notifications"
 * )
 */
class NotificationController extends ApiController
{
    protected $notificationService;

    public function __construct(NotificationService $notificationService)
    {
        $this->notificationService = $notificationService;
    }

    /**
     * Get user notifications list
     * 
     * @OA\Get(
     *      path="/api/v1/notifications",
     *      operationId="getUserNotifications",
     *      tags={"Notifications"},
     *      summary="Get user notifications",
     *      description="Get list of notifications for the authenticated user",
     *      security={{"sanctum": {}}},
     *      @OA\Parameter(
     *          name="page",
     *          description="Page number",
     *          required=false,
     *          in="query",
     *          @OA\Schema(type="integer")
     *      ),
     *      @OA\Parameter(
     *          name="per_page",
     *          description="Items per page (default: 15, max: 50)",
     *          required=false,
     *          in="query",
     *          @OA\Schema(type="integer")
     *      ),
     *      @OA\Parameter(
     *          name="unread_only",
     *          description="Filter to show only unread notifications",
     *          required=false,
     *          in="query",
     *          @OA\Schema(type="boolean")
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Successful operation",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function index(Request $request)
    {
        $user = $request->user();
        $perPage = min($request->per_page ?? 15, 50);
        $unreadOnly = filter_var($request->unread_only, FILTER_VALIDATE_BOOLEAN);

        $query = Notification::where('user_id', $user->id)
            ->orderBy('created_at', 'desc');

        if ($unreadOnly) {
            $query->where('read', false);
        }

        $notifications = $query->paginate($perPage);

        // Get unread count
        $unreadCount = Notification::where('user_id', $user->id)
            ->where('read', false)
            ->count();

        return $this->sendResponse([
            'notifications' => $notifications,
            'unread_count' => $unreadCount,
        ], 'Notifications retrieved successfully.');
    }

    /**
     * Mark notification as read
     * 
     * @OA\Post(
     *      path="/api/v1/notifications/{id}/mark-read",
     *      operationId="markNotificationAsRead",
     *      tags={"Notifications"},
     *      summary="Mark notification as read",
     *      description="Mark a specific notification as read",
     *      security={{"sanctum": {}}},
     *      @OA\Parameter(
     *          name="id",
     *          description="Notification id",
     *          required=true,
     *          in="path",
     *          @OA\Schema(type="integer")
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Notification marked as read",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      ),
     *      @OA\Response(
     *          response=404,
     *          description="Notification not found"
     *      )
     * )
     * 
     * @param Request $request
     * @param int $id
     * @return \Illuminate\Http\JsonResponse
     */
    public function markAsRead(Request $request, $id)
    {
        $user = $request->user();

        $notification = Notification::where('id', $id)
            ->where('user_id', $user->id)
            ->first();

        if (!$notification) {
            return $this->sendError('Notification not found.', [], 404);
        }

        if (!$notification->read) {
            $notification->read = true;
            $notification->save();
        }

        return $this->sendResponse($notification, 'Notification marked as read.');
    }

    /**
     * Mark all notifications as read
     * 
     * @OA\Post(
     *      path="/api/v1/notifications/mark-all-read",
     *      operationId="markAllNotificationsAsRead",
     *      tags={"Notifications"},
     *      summary="Mark all notifications as read",
     *      description="Mark all notifications for the authenticated user as read",
     *      security={{"sanctum": {}}},
     *      @OA\Response(
     *          response=200,
     *          description="All notifications marked as read",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function markAllAsRead(Request $request)
    {
        $user = $request->user();

        $updated = Notification::where('user_id', $user->id)
            ->where('read', false)
            ->update(['read' => true]);

        return $this->sendResponse([
            'marked_count' => $updated,
        ], 'All notifications marked as read.');
    }

    /**
     * Get unread notifications count
     * 
     * @OA\Get(
     *      path="/api/v1/notifications/unread-count",
     *      operationId="getUnreadNotificationsCount",
     *      tags={"Notifications"},
     *      summary="Get unread notifications count",
     *      description="Get the count of unread notifications for the authenticated user",
     *      security={{"sanctum": {}}},
     *      @OA\Response(
     *          response=200,
     *          description="Successful operation",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function unreadCount(Request $request)
    {
        $user = $request->user();

        $count = Notification::where('user_id', $user->id)
            ->where('read', false)
            ->count();

        return $this->sendResponse([
            'unread_count' => $count,
        ], 'Unread count retrieved successfully.');
    }

    /**
     * Delete a notification
     * 
     * @OA\Delete(
     *      path="/api/v1/notifications/{id}",
     *      operationId="deleteNotification",
     *      tags={"Notifications"},
     *      summary="Delete a notification",
     *      description="Delete a specific notification",
     *      security={{"sanctum": {}}},
     *      @OA\Parameter(
     *          name="id",
     *          description="Notification id",
     *          required=true,
     *          in="path",
     *          @OA\Schema(type="integer")
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Notification deleted",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      ),
     *      @OA\Response(
     *          response=404,
     *          description="Notification not found"
     *      )
     * )
     * 
     * @param Request $request
     * @param int $id
     * @return \Illuminate\Http\JsonResponse
     */
    public function destroy(Request $request, $id)
    {
        $user = $request->user();

        $notification = Notification::where('id', $id)
            ->where('user_id', $user->id)
            ->first();

        if (!$notification) {
            return $this->sendError('Notification not found.', [], 404);
        }

        $notification->delete();

        return $this->sendResponse(null, 'Notification deleted successfully.');
    }

    /**
     * Send notification to a single user
     *
     * @OA\Post(
     *      path="/api/v1/notifications/send-to-user",
     *      operationId="sendNotificationToUser",
     *      tags={"Notifications"},
     *      summary="Send notification to user",
     *      description="Send a push notification to a specific user (Admin only)",
     *      security={{"sanctum": {}}},
     *      @OA\RequestBody(
     *          required=true,
     *          @OA\JsonContent(
     *              required={"user_id", "title", "body"},
     *              @OA\Property(property="user_id", type="integer", example=1),
     *              @OA\Property(property="title", type="string", example="New Offer!"),
     *              @OA\Property(property="body", type="string", example="Check out our latest deals"),
     *              @OA\Property(property="data", type="object")
     *          )
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Notification sent",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      ),
     *      @OA\Response(
     *          response=422,
     *          description="Validation error"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function sendToUser(Request $request)
    {
        $request->validate([
            'user_id' => 'required|exists:users,id',
            'title' => 'required|string|max:255',
            'body' => 'required|string',
            'data' => 'nullable|array'
        ]);

        $user = User::findOrFail($request->user_id);

        // Store notification in database
        $notification = Notification::create([
            'user_id' => $user->id,
            'title' => $request->title,
            'message' => $request->body,
            'type' => 'push',
            'data' => $request->data ?? [],
            'read' => false,
        ]);

        // Send push notification via Firebase
        $payload = [
            'notification' => [
                'title' => $request->title,
                'body' => $request->body
            ],
            'data' => $request->data ?? []
        ];

        $result = $this->notificationService->sendToUser($user, $payload);

        return $this->sendResponse([
            'notification' => $notification,
            'push_result' => $result,
        ], 'Notification sent successfully.');
    }

    /**
     * Send notification to a user group
     *
     * @OA\Post(
     *      path="/api/v1/notifications/send-to-group",
     *      operationId="sendNotificationToUserGroup",
     *      tags={"Notifications"},
     *      summary="Send notification to user group",
     *      description="Send a push notification to all users in a group (Admin only)",
     *      security={{"sanctum": {}}},
     *      @OA\RequestBody(
     *          required=true,
     *          @OA\JsonContent(
     *              required={"user_group_id", "title", "body"},
     *              @OA\Property(property="user_group_id", type="integer", example=1),
     *              @OA\Property(property="title", type="string", example="Group Announcement"),
     *              @OA\Property(property="body", type="string", example="Important update for your group"),
     *              @OA\Property(property="data", type="object")
     *          )
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Notification sent",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      ),
     *      @OA\Response(
     *          response=422,
     *          description="Validation error"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function sendToUserGroup(Request $request)
    {
        $request->validate([
            'user_group_id' => 'required|exists:user_groups,id',
            'title' => 'required|string|max:255',
            'body' => 'required|string',
            'data' => 'nullable|array'
        ]);

        $userGroup = UserGroup::with('users')->findOrFail($request->user_group_id);

        // Store notifications in database for each user in the group
        $notifications = [];
        foreach ($userGroup->users as $user) {
            $notifications[] = Notification::create([
                'user_id' => $user->id,
                'title' => $request->title,
                'message' => $request->body,
                'type' => 'push',
                'data' => $request->data ?? [],
                'read' => false,
            ]);
        }

        // Send push notification via Firebase
        $payload = [
            'notification' => [
                'title' => $request->title,
                'body' => $request->body
            ],
            'data' => $request->data ?? []
        ];

        $result = $this->notificationService->sendToUserGroup($userGroup, $payload);

        return $this->sendResponse([
            'notifications_created' => count($notifications),
            'push_result' => $result,
        ], 'Notification sent to group successfully.');
    }

    /**
     * Register or update device token for a user
     *
     * @OA\Post(
     *      path="/api/v1/notifications/register-device",
     *      operationId="registerDeviceToken",
     *      tags={"Notifications"},
     *      summary="Register device token",
     *      description="Register or update FCM device token for push notifications",
     *      security={{"sanctum": {}}},
     *      @OA\RequestBody(
     *          required=true,
     *          @OA\JsonContent(
     *              required={"device_token"},
     *              @OA\Property(property="device_token", type="string", example="fcm_token_here")
     *          )
     *      ),
     *      @OA\Response(
     *          response=200,
     *          description="Device token registered",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      ),
     *      @OA\Response(
     *          response=422,
     *          description="Validation error"
     *      )
     * )
     * 
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function registerDeviceToken(Request $request)
    {
        $request->validate([
            'device_token' => 'required|string'
        ]);

        $user = $request->user();
        $user->device_token = $request->device_token;
        $user->save();

        return $this->sendResponse(null, 'Device token registered successfully.');
    }

    /**
     * Get Firebase notification statistics
     *
     * @OA\Get(
     *      path="/api/v1/notifications/statistics",
     *      operationId="getNotificationStatistics",
     *      tags={"Notifications"},
     *      summary="Get notification statistics",
     *      description="Get Firebase notification statistics (Admin only)",
     *      security={{"sanctum": {}}},
     *      @OA\Response(
     *          response=200,
     *          description="Successful operation",
     *       ),
     *      @OA\Response(
     *          response=401,
     *          description="Unauthenticated"
     *      )
     * )
     * 
     * @return \Illuminate\Http\JsonResponse
     */
    public function getStatistics()
    {
        $stats = $this->notificationService->getStatistics();
        return $this->sendResponse($stats, 'Statistics retrieved successfully.');
    }
}